- name: Install postfix and mailutils
  apt:
    name:
      - postfix
      - mailutils
    state: present
    update_cache: yes

- name: Configure Postfix relayhost
  lineinfile:
    path: /etc/postfix/main.cf
    regexp: "^relayhost ="
    line: "relayhost = [{{ mailrise_hostname }}]:8025"
    create: yes
    backup: yes

- name: Disable local delivery (force all mail through relayhost)
  lineinfile:
    path: /etc/postfix/main.cf
    regexp: "^mydestination ="
    line: "mydestination ="
    create: yes
    backup: yes

- name: Configure Postfix SASL settings
  blockinfile:
    path: /etc/postfix/main.cf
    marker: "# {mark} ANSIBLE MANAGED SASL SETTINGS"
    block: |
      smtp_sasl_auth_enable = yes
      smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
      smtp_sasl_security_options = noanonymous

- name: Create sasl_passwd file
  template:
    src: sasl_passwd.j2
    dest: /etc/postfix/sasl_passwd
    owner: root
    group: root
    mode: "0600"

- name: Generate hash db for sasl_passwd
  command: postmap /etc/postfix/sasl_passwd
  args:
    creates: /etc/postfix/sasl_passwd.db

- name: Update smtpd_tls_security_level to none
  lineinfile:
    path: /etc/postfix/main.cf
    regexp: "^smtpd_tls_security_level=may"
    line: "smtpd_tls_security_level=none"
    create: yes
    backup: yes

- name: Restart Postfix
  service:
    name: postfix
    state: restarted
    enabled: yes
