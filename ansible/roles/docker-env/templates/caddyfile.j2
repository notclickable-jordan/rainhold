{
    admin 0.0.0.0:2019

    log {
        output file /var/log/caddy/access.log {
            roll_size 10MiB
            roll_keep 7
            roll_keep_for 7d
        }
        format json
    }

    metrics
}

ldap.notclickable.com {
    reverse_proxy {{ ansible_host }}:4202

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }
}

pocket-id.notclickable.com {
    reverse_proxy {{ ansible_host }}:4203

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }
}

dozzle.notclickable.com {
    forward_auth {{ ansible_host }}:4206 {
        uri /api/auth/caddy
        copy_headers Remote-User Remote-Email Remote-Name Remote-Groups
    }

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }

    reverse_proxy {{ ansible_host }}:4204
}

notclickable.com {
    reverse_proxy {{ ansible_host }}:4205

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }
}

www.notclickable.com {
    reverse_proxy {{ ansible_host }}:4205

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }
}

tinyauth.notclickable.com {
    reverse_proxy {{ ansible_host }}:4206

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }
}

mailrise.notclickable.com:465 {
    reverse_proxy {{ ansible_host }}:465

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }
}

gitea.notclickable.com {
    forward_auth {{ ansible_host }}:4206 {
        uri /api/auth/caddy
        copy_headers Remote-User Remote-Email Remote-Name Remote-Groups
    }

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }

    reverse_proxy {{ ansible_host }}:4208
}

n8n.notclickable.com {
    forward_auth {{ ansible_host }}:4206 {
        uri /api/auth/caddy
        copy_headers Remote-User Remote-Email Remote-Name Remote-Groups
    }

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }

    reverse_proxy {{ ansible_host }}:4210
}

lemmy.notclickable.com {
    reverse_proxy {{ ansible_host }}:4211

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }
}

miniflux.notclickable.com {
    reverse_proxy {{ ansible_host }}:4212

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }
}

grafana.notclickable.com {
    forward_auth {{ ansible_host }}:4206 {
        uri /api/auth/caddy
        copy_headers Remote-User Remote-Email Remote-Name Remote-Groups
    }

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }

    reverse_proxy {{ ansible_host }}:4213
}

jellyfin.notclickable.com {
    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }

    reverse_proxy {{ ansible_host }}:4219
}

notclickable.social, www.notclickable.social {
        @local {
                file
                not path /
        }
        @streaming {
                path /api/v1/streaming /api/v1/streaming/*
        }
        @cache_control {
                path_regexp ^/(emoji|packs|/system/accounts/avatars|/system/media_attachments/files)
        }

        root * /home/mastodon/live/public

        log {
                output file /var/log/caddy/mastodon.log
        }

        handle_errors {
                rewrite 500.html
                file_server
        }

        header {
                Strict-Transport-Security "max-age=31536000"
        }
        header /sw.js Cache-Control "public, max-age=0"
        header @cache_control Cache-Control "public, max-age=31536000, immutable"

        handle @local {
                file_server
        }

        tls {
            dns cloudflare {{ cloudflare_ssl_api_token }}
        }

        reverse_proxy @streaming {
                to {{ ansible_host }}:4218
                header_up X-Forwarded-Port 443
                header_up X-Forwarded-Proto https

                transport http {
                        keepalive 5s
                        keepalive_idle_conns 10
                }
        }

        reverse_proxy {
                to {{ ansible_host }}:4217
                header_up X-Forwarded-Port 443
                header_up X-Forwarded-Proto https

                transport http {
                        keepalive 5s
                        keepalive_idle_conns 10
                }
        }
}

calibre.notclickable.com {
    forward_auth {{ ansible_host }}:4206 {
        uri /api/auth/caddy
        copy_headers Remote-User Remote-Email Remote-Name Remote-Groups
    }

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }

    reverse_proxy {{ ansible_host }}:4220
}

ytptube.notclickable.com {
    forward_auth {{ ansible_host }}:4206 {
        uri /api/auth/caddy
        copy_headers Remote-User Remote-Email Remote-Name Remote-Groups
    }

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }

    reverse_proxy {{ ansible_host }}:4221
}

audiobookshelf.notclickable.com {
    forward_auth {{ ansible_host }}:4206 {
        uri /api/auth/caddy
        copy_headers Remote-User Remote-Email Remote-Name Remote-Groups
    }

    tls {
        dns cloudflare {{ cloudflare_ssl_api_token }}
    }

    reverse_proxy {{ ansible_host }}:4222
}

starbase80.dev, www.starbase80.dev {
    redir https://github.com/notclickable-jordan/starbase-80
}